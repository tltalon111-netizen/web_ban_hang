<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω H√≥a ƒë∆°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">
    <div class="container card shadow p-0">
        <div class="card-header bg-dark text-white d-flex justify-content-between py-3">
            <h5 class="mb-0">üìú DANH S√ÅCH H√ìA ƒê∆†N</h5>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAddHD">+ T·∫°o h√≥a ƒë∆°n m·ªõi</button>
        </div>
        <div class="card-body">
            <table class="table table-hover text-center">
                <thead class="table-secondary">
                    <tr><th>M√£ Hƒê</th><th>Ng√†y b√°n</th><th>Ng∆∞·ªùi l·∫≠p</th><th>T·ªïng ti·ªÅn</th><th>Thao t√°c</th></tr>
                </thead>
                <tbody id="hoadontable"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="modalAddHD" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>T·∫°o h√≥a ƒë∆°n m·ªõi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Nh√¢n vi√™n l·∫≠p</label>
                        <select id="id_nguoi_dung" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label>S·∫£n ph·∫©m b√°n</label>
                        <select id="id_san_pham" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label>S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="so_luong" class="form-control" value="1">
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-success" id="btnSaveHD">L∆∞u h√≥a ƒë∆°n</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetail" tabindex="-1">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header"><h5>Chi ti·∫øt h√≥a ƒë∆°n</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><table class="table table-bordered">
                <thead><tr><th>S·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th></tr></thead>
                <tbody id="detailtable"></tbody>
            </table></div>
        </div></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            loadHoaDon();
            setupForm(); // L·∫•y d·ªØ li·ªáu cho c√°c √¥ ch·ªçn

            function loadHoaDon() {
                $.post('hoadon_api.php', {action: 'fetch'}, function(data) {
                    let list = JSON.parse(data); let rows = '';
                    list.forEach(item => {
                        rows += `<tr><td>${item.id_hoa_don}</td><td>${item.ngay_ban}</td><td>${item.ten_dang_nhap}</td><td class="fw-bold text-danger">${Number(item.tong_tien).toLocaleString()} ƒë</td><td><button class="btn btn-info btn-sm btn-view" data-id="${item.id_hoa_don}">Xem chi ti·∫øt</button></td></tr>`;
                    });
                    $('#hoadontable').html(rows);
                });
            }

            function setupForm() {
                $.post('hoadon_api.php', {action: 'fetch_setup'}, function(data) {
                    let res = JSON.parse(data);
                    let optU = ''; res.users.forEach(u => optU += `<option value="${u.id_nguoi_dung}">${u.ten_dang_nhap}</option>`);
                    $('#id_nguoi_dung').html(optU);
                    let optP = ''; res.prods.forEach(p => optP += `<option value="${p.id_san_pham}">${p.ten_san_pham} (Gi√°: ${p.gia_ban})</option>`);
                    $('#id_san_pham').html(optP);
                });
            }

            $('#btnSaveHD').click(function() {
                let payload = {
                    action: 'insert',
                    id_nguoi_dung: $('#id_nguoi_dung').val(),
                    id_san_pham: $('#id_san_pham').val(),
                    so_luong: $('#so_luong').val()
                };
                $.post('hoadon_api.php', payload, function(res) {
                    if(res.trim() == "Success") {
                        alert("ƒê√£ t·∫°o h√≥a ƒë∆°n!"); $('#modalAddHD').modal('hide'); loadHoaDon();
                    } else { alert("L·ªói: " + res); }
                });
            });

            $(document).on('click', '.btn-view', function() {
                let id = $(this).data('id');
                $.post('hoadon_api.php', {action: 'fetch_detail', id_hoa_don: id}, function(data) {
                    let list = JSON.parse(data); let rows = '';
                    list.forEach(item => {
                        rows += `<tr><td>${item.ten_san_pham}</td><td>${item.so_luong}</td><td>${Number(item.don_gia).toLocaleString()}</td><td>${Number(item.thanh_tien).toLocaleString()}</td></tr>`;
                    });
                    $('#detailtable').html(rows); $('#modalDetail').modal('show');
                });
            });
        });
    </script>
</body>
</html>